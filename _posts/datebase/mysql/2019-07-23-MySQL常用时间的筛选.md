---
layout: articles
title: Mysql常用的时间筛选
tags:  mysql
author: Warning
key:    datebase-mysql-head-03
aside:
  toc: true
sidebar:
nav: DateBase
category: [datebase, mysql]
---

MySql常用的对于时间的处理方法

<!--more-->

## 一、直接拿字段比较

- 以下这两种方式最终效果一样

```sql
SELECT bb.borrow_no,bb.create_time FROM borrow bb WHERE bb.create_time>='2021-07-11 00:00:00';

SELECT bb.borrow_no,bb.create_time FROM borrow bb WHERE bb.create_time>='2021-07-11';

```

| borrow_no            | create_time         |
| -------------------- | ------------------- |
| HLW-1000001621658826 | 2021-07-11 13:39:27 |
| HLW-1000001587789196 | 2021-07-11 14:36:02 |
| HLW-1000000818367793 | 2021-07-11 14:55:53 |

- 如何查询某一天(2021-07-10)

#### 正确方法

```sql
SELECT bb.borrow_no,bb.create_time FROM borrow bb WHERE bb.create_time>='2021-07-10' and bb.create_time <='2021-07-11';

```

#### 错误方法：

```sql
SELECT bb.borrow_no,bb.create_time FROM borrow bb WHERE bb.create_time='2021-07-10';

```

> 直接用时间字段去比较的时候，等号后面需要精确到原始时间的时分秒，2021-07-10 不能代表 2021-07-10 12:22:33

## 二、查询最近几天的信息

> 程序中，如果查询最近几天的记录，就需要获取当前日期的时间，然后再动态生成最终结果，如果再把sql的时间都写死，最终就无法达到需求。

### 1. 函数now():

```sql
select NOW();
```

| NOW()               |
| ------------------- |
| 2021-07-11 17:53:06 |

### 2. 函数CURRENT_DATE():

```sql
select CURRENT_DATE();
```

| CURRENT_DATE |
| ------------ |
| 2021-07-11   |

### 3. 查询当日的记录（以下两种方式结果相同）

```sql
SELECT * FROM borrow bb WHERE DATE_FORMAT(bb.create_time, '%Y%m%d')=DATE_FORMAT(CURRENT_DATE(), '%Y%m%d' );

SELECT * FROM borrow bb WHERE TO_DAYS(bb.create_time)=TO_DAYS(now());
```

> 如上两种方式，都使用的等号=准确的表达了想要查询的时间段

### 4. 查询昨日的记录

```sql
SELECT * FROM borrow bb WHERE TO_DAYS( NOW( ) ) - TO_DAYS( bb.create_time) =1;

```

### 5. 查询近7天的数据（以下两种方式结果相同）

```sql
SELECT * FROM borrow bb WHERE TO_DAYS( NOW( ) ) - TO_DAYS( bb.create_time) <= 7;

SELECT bb.borrow_no,bb.create_time FROM borrow bb where DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= date(bb.create_time);
```

### 6. 查询本月的数据

```sql
SELECT * FROM borrow bb WHERE DATE_FORMAT( bb.create_time, '%Y%m' ) = DATE_FORMAT( CURDATE( ) , '%Y%m' );
```

### 7. 查询上个月的数据

```sql
SELECT * FROM borrow bb WHERE PERIOD_DIFF( date_format( now( ) , '%Y%m' ) , date_format( bb.create_time, '%Y%m' ) ) =1
```



## 三、MyBatis集成的一点点坑



上面用在xml中直接使用 “<=” 的时候，项目启动报错 ` Caused by: org.xml.sax.SAXParseException: 元素内容必须由格式正确的字符数据或标记组成。 `

```java
Caused by: org.apache.ibatis.builder.BuilderException: Error creating document instance.  Cause: org.xml.sax.SAXParseException; lineNumber: 57; columnNumber: 24; 元素内容必须由格式正确的字符数据或标记组成。
	at org.apache.ibatis.parsing.XPathParser.createDocument(XPathParser.java:259)
	at org.apache.ibatis.parsing.XPathParser.<init>(XPathParser.java:125)
	at org.apache.ibatis.builder.xml.XMLMapperBuilder.<init>(XMLMapperBuilder.java:78)
	at com.baomidou.mybatisplus.spring.MybatisSqlSessionFactoryBean.buildSqlSessionFactory(MybatisSqlSessionFactoryBean.java:581)
	... 81 common frames omitted
Caused by: org.xml.sax.SAXParseException: 元素内容必须由格式正确的字符数据或标记组成。
	at com.sun.org.apache.xerces.internal.util.ErrorHandlerWrapper.createSAXParseException(ErrorHandlerWrapper.java:203)
	at com.sun.org.apache.xerces.internal.util.ErrorHandlerWrapper.fatalError(ErrorHandlerWrapper.java:177)
	at com.sun.org.apache.xerces.internal.impl.XMLErrorReporter.reportError(XMLErrorReporter.java:441)
	at com.sun.org.apache.xerces.internal.impl.XMLErrorReporter.reportError(XMLErrorReporter.java:368)
	at com.sun.org.apache.xerces.internal.impl.XMLScanner.reportFatalError(XMLScanner.java:1436)
	at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDriver.startOfMarkup(XMLDocumentFragmentScannerImpl.java:2636)
	at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDriver.next(XMLDocumentFragmentScannerImpl.java:2734)
	at com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl.next(XMLDocumentScannerImpl.java:606)
	at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:510)
	at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:848)
	at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:777)
	at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:141)
	at com.sun.org.apache.xerces.internal.parsers.DOMParser.parse(DOMParser.java:243)
	at com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderImpl.parse(DocumentBuilderImpl.java:348)
	at org.apache.ibatis.parsing.XPathParser.createDocument(XPathParser.java:257)
	... 84 common frames omitted

Disconnected from the target VM, address: '127.0.0.1:54640', transport: 'socket'

```



后来突然想起来，有些字符需要转译，拿<![CDATA[ ]]> 阔上就行了……

低级错误

> ```mysql
> <![CDATA[ and jh.CJSJ >= #{dto.cjsj}  and jh.CJSJ <= DATE_ADD(#{dto.cjsj},INTERVAL 1 DAY) ]]>
> ```



------





# 附录
## A 资源
## B 参考资料


